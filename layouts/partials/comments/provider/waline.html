<link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css"/>
<div id="waline" class="waline-container"></div>
<style>
  .waline-container { /* 样式保持不变 */ }
</style>

{{- $showReaction := (default true .Params.reaction) -}}
{{- with .Site.Params.comments.waline -}}
  {{- $config := dict "el" "#waline" "dark" `html[data-scheme="dark"]` -}}
  {{- $replaceKeys := dict 
    "serverurl" "serverURL"
    "requiredmeta" "requiredMeta"
    "wordlimit" "wordLimit" 
    "pagesize" "pageSize"
    "imageuploader" "imageUploader"
    "texrenderer" "texRenderer"
    "commentsorting" "commentSorting"
    "recaptchav3key" "reCaptchaV3Key"
    "turnstilekey" "turnstileKey"
  -}}
  {{- $replaceLocaleKeys := dict 
    "reactiontitle" "reactionTitle"
    "gifsearchplaceholder" "gifSearchPlaceholder"
    "nickerror" "nickError"
    "mailerror" "mailError"
    "wordhint" "wordHint"
    "cancellike" "cancelLike"
    "cancelreply" "cancelReply"
    "uploadimage" "uploadImage"
  -}}

  {{- range $key, $val := . -}}
    {{- if ne $val nil -}}
      {{- $replaceKey := index $replaceKeys $key -}}
      {{- $k := default $key $replaceKey -}}

      {{- if eq $k "locale" -}}
        {{- $locale := dict -}}
        {{- range $lkey, $lval := $val -}}
          {{- if ne $lval nil -}}
            {{- $replaceLKey := index $replaceLocaleKeys $lkey -}}
            {{- $lk := default $lkey $replaceLKey -}}
            {{- $locale = merge $locale (dict $lk $lval) -}}
          {{- end -}}
        {{- end -}}
        {{- $config = merge $config (dict $k $locale) -}}
      {{- else if eq $k "reaction" -}}
        {{- $config = merge $config (dict $k (cond $showReaction $val false)) -}}
      {{- else -}}
        {{- $config = merge $config (dict $k $val) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    
    document.addEventListener('DOMContentLoaded', () => {
      const waline = init({{ $config | jsonify | safeJS }});
      
      // 可选：添加错误监听
      waline.update({}).catch((err) => {
        console.error('Waline 初始化失败:', err);
      });
    });
  </script>
{{- end -}}